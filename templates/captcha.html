<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure the Queue - ASL CAPTCHA</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
        min-height: 100vh;
        color: white;
      }

      .header {
        background: linear-gradient(90deg, #ff6b6b 0%, #ffa502 100%);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .header .back-btn {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }
      .header h1 {
        font-size: 1.3rem;
      }
      .mode-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      .main-content {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
      }

      .video-section {
        flex: 1;
        min-width: 400px;
      }
      .video-container {
        background: #0a0a1a;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid #ff6b6b;
        position: relative;
      }
      .video-container img {
        width: 100%;
        display: block;
      }
      .live-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: #ff0000;
        color: white;
        padding: 5px 12px;
        border-radius: 5px;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .live-badge::before {
        content: "";
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .controls-section {
        flex: 0 0 350px;
      }

      /* 3 Letter Challenge Box */
      .challenge-box {
        background: linear-gradient(145deg, #1a1a3e 0%, #0f0f2d 100%);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        border: 1px solid #3a3a6a;
        margin-bottom: 20px;
      }
      .challenge-box h3 {
        color: #aabbcc;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 20px;
      }

      .letters-display {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }
      .letter-box {
        width: 80px;
        height: 90px;
        background: #0a0a1a;
        border: 3px solid #3a3a6a;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .letter-box .letter {
        font-size: 2.5rem;
        font-weight: 700;
        color: #556677;
      }
      .letter-box .status {
        font-size: 0.7rem;
        color: #556677;
        margin-top: 5px;
      }
      .letter-box.active {
        border-color: #ff6b6b;
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
      }
      .letter-box.active .letter {
        color: #ff6b6b;
        text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
      }
      .letter-box.active .status {
        color: #ff6b6b;
      }
      .letter-box.completed {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
      }
      .letter-box.completed .letter {
        color: #00ff88;
      }
      .letter-box.completed .status {
        color: #00ff88;
      }

      .challenge-box p {
        color: #8899aa;
        font-size: 0.85rem;
      }

      .status-box {
        background: #0f0f2d;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #2a2a5a;
        margin-bottom: 20px;
      }
      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #1a1a3a;
      }
      .status-item:last-child {
        border-bottom: none;
      }
      .status-label {
        color: #8899aa;
      }
      .status-value {
        font-weight: 600;
        color: #ff6b6b;
      }
      .status-value.verified {
        color: #00ff88;
      }
      .status-value.pending {
        color: #ffa502;
      }

      /* Progress Steps */
      .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        padding: 0 10px;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .step-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #2a2a5a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s;
      }
      .step.active .step-circle {
        background: #ff6b6b;
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
      }
      .step.completed .step-circle {
        background: #00ff88;
      }
      .step-label {
        font-size: 0.75rem;
        color: #556677;
      }
      .step.active .step-label {
        color: #ff6b6b;
      }
      .step.completed .step-label {
        color: #00ff88;
      }

      .btn {
        width: 100%;
        padding: 16px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
      }
      .btn-primary {
        background: linear-gradient(90deg, #ff6b6b 0%, #ffa502 100%);
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .btn-secondary {
        background: #2a2a5a;
        color: #aabbcc;
      }
      .btn-secondary:hover {
        background: #3a3a6a;
      }

      .info-box {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
      }
      .info-box h4 {
        color: #ff6b6b;
        margin-bottom: 10px;
      }
      .info-box ul {
        color: #aabbcc;
        font-size: 0.85rem;
        padding-left: 20px;
      }
      .info-box li {
        margin-bottom: 6px;
      }

      /* Success Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: linear-gradient(145deg, #1a3a5c 0%, #0d2840 100%);
        border-radius: 20px;
        padding: 50px;
        text-align: center;
        border: 3px solid #00ff88;
        box-shadow: 0 0 60px rgba(0, 255, 136, 0.3);
        max-width: 450px;
      }
      .modal-content .checkmark {
        font-size: 5rem;
        margin-bottom: 20px;
      }
      .modal-content h2 {
        color: #00ff88;
        font-size: 2rem;
        margin-bottom: 15px;
      }
      .modal-content p {
        color: #aabbcc;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }
      .completed-letters {
        font-size: 2rem;
        color: #00ff88;
        margin: 20px 0;
        letter-spacing: 10px;
      }
      .btn-success {
        background: linear-gradient(90deg, #00aa55 0%, #00ff88 100%);
        color: white;
        padding: 16px 40px;
        font-size: 1.1rem;
        margin-top: 20px;
      }

      /* Timer warning */
      .timer-warning {
        color: #ff4757 !important;
        animation: timerPulse 0.5s infinite;
      }
      @keyframes timerPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <a href="/" class="back-btn">‚Üê Back to Home</a>
      <h1>üîí Secure the Queue</h1>
      <span class="mode-badge">3-Letter Challenge</span>
    </header>

    <div class="container">
      <div class="main-content">
        <div class="video-section">
          <div class="video-container">
            <div class="live-badge">LIVE</div>
            <img src="{{ url_for('video_feed') }}" alt="Camera Feed" />
          </div>
        </div>

        <div class="controls-section">
          <div class="challenge-box">
            <h3>Sign These 3 Letters</h3>

            <div class="letters-display">
              <div class="letter-box" id="letter1">
                <span class="letter">?</span>
                <span class="status">waiting</span>
              </div>
              <div class="letter-box" id="letter2">
                <span class="letter">?</span>
                <span class="status">waiting</span>
              </div>
              <div class="letter-box" id="letter3">
                <span class="letter">?</span>
                <span class="status">waiting</span>
              </div>
            </div>

            <p>Complete all 3 letters within 60 seconds</p>
          </div>

          <div class="progress-steps">
            <div class="step" id="step1">
              <div class="step-circle">1</div>
              <span class="step-label">First</span>
            </div>
            <div class="step" id="step2">
              <div class="step-circle">2</div>
              <span class="step-label">Second</span>
            </div>
            <div class="step" id="step3">
              <div class="step-circle">3</div>
              <span class="step-label">Third</span>
            </div>
          </div>

          <div class="status-box">
            <div class="status-item">
              <span class="status-label">Status</span>
              <span class="status-value pending" id="verifyStatus">Ready</span>
            </div>
            <div class="status-item">
              <span class="status-label">Progress</span>
              <span class="status-value" id="progress">0 / 3</span>
            </div>
            <div class="status-item">
              <span class="status-label">Time Left</span>
              <span class="status-value" id="timer">60s</span>
            </div>
          </div>

          <button
            class="btn btn-primary"
            id="startBtn"
            onclick="startVerification()"
          >
            üöÄ Start 3-Letter Challenge
          </button>

          <button class="btn btn-secondary" onclick="newChallenge()">
            üîÑ New Letters
          </button>

          <div class="info-box">
            <h4>üí° 3-Letter Challenge</h4>
            <ul>
              <li>Click "Start" to begin</li>
              <li>Sign each letter in order</li>
              <li>Hold each sign steady to verify</li>
              <li>Complete all 3 within 60 seconds!</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
      <div class="modal-content">
        <div class="checkmark">üéâ</div>
        <h2>All 3 Verified!</h2>
        <p>You successfully signed:</p>
        <div class="completed-letters" id="completedLetters">A B C</div>
        <p>Human verification complete!</p>
        <button class="btn btn-success" onclick="proceedToCheckout()">
          Continue to Checkout ‚Üí
        </button>
      </div>
    </div>

    <script>
      let timerInterval = null;
      let timeRemaining = 60;
      let checkInterval = null;
      let targetLetters = [];

      function startVerification() {
        fetch("/start_captcha")
          .then((response) => response.json())
          .then((data) => {
            targetLetters = data.target_letters;

            // Update letter boxes
            document
              .getElementById("letter1")
              .querySelector(".letter").innerText = targetLetters[0];
            document
              .getElementById("letter2")
              .querySelector(".letter").innerText = targetLetters[1];
            document
              .getElementById("letter3")
              .querySelector(".letter").innerText = targetLetters[2];

            // Reset states
            resetLetterBoxes();
            document.getElementById("letter1").classList.add("active");
            document
              .getElementById("letter1")
              .querySelector(".status").innerText = "SIGN NOW";
            document.getElementById("step1").classList.add("active");

            document.getElementById("verifyStatus").innerText = "Verifying...";
            document.getElementById("verifyStatus").className =
              "status-value pending";
            document.getElementById("startBtn").innerText = "‚è≥ In Progress...";
            document.getElementById("startBtn").disabled = true;
            document.getElementById("progress").innerText = "0 / 3";

            timeRemaining = data.timeout;
            document.getElementById("timer").innerText = timeRemaining + "s";
            document.getElementById("timer").classList.remove("timer-warning");

            startTimer();
            startStatusCheck();
          });
      }

      function resetLetterBoxes() {
        for (let i = 1; i <= 3; i++) {
          const box = document.getElementById("letter" + i);
          const step = document.getElementById("step" + i);
          box.classList.remove("active", "completed");
          box.querySelector(".status").innerText = "waiting";
          step.classList.remove("active", "completed");
        }
      }

      function updateProgress(currentIndex, lettersCompleted) {
        // Update letter boxes
        for (let i = 0; i < 3; i++) {
          const box = document.getElementById("letter" + (i + 1));
          const step = document.getElementById("step" + (i + 1));

          box.classList.remove("active", "completed");
          step.classList.remove("active", "completed");

          if (i < currentIndex) {
            // Completed
            box.classList.add("completed");
            box.querySelector(".status").innerText = "‚úì Done";
            step.classList.add("completed");
            step.querySelector(".step-circle").innerText = "‚úì";
          } else if (i === currentIndex) {
            // Active
            box.classList.add("active");
            box.querySelector(".status").innerText = "SIGN NOW";
            step.classList.add("active");
          } else {
            // Waiting
            box.querySelector(".status").innerText = "waiting";
          }
        }

        document.getElementById("progress").innerText = currentIndex + " / 3";
      }

      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          timeRemaining--;
          document.getElementById("timer").innerText = timeRemaining + "s";

          if (timeRemaining <= 15) {
            document.getElementById("timer").classList.add("timer-warning");
          }

          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            clearInterval(checkInterval);
            document.getElementById("verifyStatus").innerText = "Timeout!";
            document.getElementById("verifyStatus").className = "status-value";
            document.getElementById("verifyStatus").style.color = "#ff4757";
            document.getElementById("startBtn").innerText = "üöÄ Try Again";
            document.getElementById("startBtn").disabled = false;
          }
        }, 1000);
      }

      function startStatusCheck() {
        if (checkInterval) clearInterval(checkInterval);

        checkInterval = setInterval(() => {
          fetch("/check_status")
            .then((response) => response.json())
            .then((data) => {
              updateProgress(data.current_index, data.letters_completed);

              if (data.verified) {
                clearInterval(timerInterval);
                clearInterval(checkInterval);

                // Mark all as completed
                for (let i = 1; i <= 3; i++) {
                  document
                    .getElementById("letter" + i)
                    .classList.remove("active");
                  document
                    .getElementById("letter" + i)
                    .classList.add("completed");
                  document
                    .getElementById("letter" + i)
                    .querySelector(".status").innerText = "‚úì Done";
                  document
                    .getElementById("step" + i)
                    .classList.add("completed");
                  document
                    .getElementById("step" + i)
                    .querySelector(".step-circle").innerText = "‚úì";
                }

                document.getElementById("verifyStatus").innerText = "Complete!";
                document.getElementById("verifyStatus").className =
                  "status-value verified";
                document.getElementById("progress").innerText = "3 / 3";
                document.getElementById("completedLetters").innerText =
                  targetLetters.join(" ");

                setTimeout(() => {
                  document
                    .getElementById("successModal")
                    .classList.add("active");
                }, 500);
              }
            });
        }, 400);
      }

      function newChallenge() {
        fetch("/new_challenge")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "locked") {
              alert(data.message);
              return;
            }
            targetLetters = data.target_letters;

            document
              .getElementById("letter1")
              .querySelector(".letter").innerText = targetLetters[0];
            document
              .getElementById("letter2")
              .querySelector(".letter").innerText = targetLetters[1];
            document
              .getElementById("letter3")
              .querySelector(".letter").innerText = targetLetters[2];

            resetLetterBoxes();
            document.getElementById("timer").innerText = "60s";
            document.getElementById("timer").classList.remove("timer-warning");
            document.getElementById("progress").innerText = "0 / 3";
            document.getElementById("startBtn").innerText =
              "üöÄ Start 3-Letter Challenge";
            document.getElementById("startBtn").disabled = false;
            document.getElementById("verifyStatus").innerText = "Ready";
            document.getElementById("verifyStatus").style.color = "";
            timeRemaining = 60;
          });
      }

      function proceedToCheckout() {
        window.location.href = "/success";
      }
    </script>
  </body>
</html>
